<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoxjahon Restaurant - Stock Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shoxjahon-rest-stock';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.fs = { doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, serverTimestamp };
        
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            window.user = user;
            if (user) {
                loadDynamicMenu();
            }
        });
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #0f1115; color: #e5e7eb; scroll-behavior: smooth; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .gold-gradient { background: linear-gradient(135deg, #d4af37 0%, #f9d976 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card-glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .card-glass:hover { transform: translateY(-5px); border-color: rgba(212, 175, 55, 0.4); }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #d4af37; color: black; font-size: 10px; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        #cart-panel, #admin-panel { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #cart-panel.open, #admin-panel.open { transform: translateX(0); }
        .category-btn.active { background: #d4af37; color: black; border-color: #d4af37; }
        .lang-btn.active { color: #d4af37; font-weight: bold; }
        #product-modal, #qr-modal, #login-modal { display: none; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); }
        .admin-only { display: none; }
        .is-admin .admin-only { display: inline-flex; }
        .is-admin #login-trigger { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="sticky top-0 z-50 bg-[#0f1115]/95 border-b border-white/5 py-4 px-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="text-xl font-serif gold-gradient cursor-pointer" onclick="location.reload()">Shoxjahon</div>
            <div id="admin-controls" class="flex items-center gap-2">
                <button id="login-trigger" onclick="openLogin()" class="text-[10px] text-gray-500 hover:text-white uppercase tracking-widest"><i class="fa-solid fa-lock text-[8px] mr-1"></i> Admin</button>
                <button onclick="toggleAdmin()" class="admin-only bg-yellow-500/10 text-yellow-500 border border-yellow-500/30 px-3 py-1 rounded-full text-[10px] font-bold uppercase hover:bg-yellow-500 hover:text-black transition">
                    <i class="fa-solid fa-layer-group mr-1"></i> –°–∫–ª–∞–¥ & –ú–µ–Ω—é
                </button>
                <button onclick="logoutAdmin()" class="admin-only bg-red-500/10 text-red-500 border border-red-500/30 px-3 py-1 rounded-full text-[10px] font-bold uppercase hover:bg-red-500 hover:text-white transition">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button onclick="showQRCode()" class="text-white hover:text-yellow-500 transition text-xs border border-white/10 px-2 py-1 rounded-full"><i class="fa-solid fa-qrcode"></i></button>
            <div class="flex gap-2 text-[10px] font-bold uppercase border-x border-white/10 px-2">
                <button onclick="setLang('ru')" id="lang-ru" class="lang-btn">RU</button>
                <button onclick="setLang('uz')" id="lang-uz" class="lang-btn">UZ</button>
            </div>
            <button onclick="toggleCart()" class="relative p-2 text-white hover:text-yellow-500 transition">
                <i class="fa-solid fa-shopping-bag text-xl"></i>
                <span id="cart-count" class="cart-badge">0</span>
            </button>
        </div>
    </nav>

    <header class="relative h-[15vh] flex items-center justify-center overflow-hidden">
        <div class="absolute inset-0 bg-black/60 z-10"></div>
        <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=1200" class="absolute inset-0 w-full h-full object-cover" alt="Hero">
        <div class="relative z-20 text-center px-4">
            <h1 id="hero-title" class="text-2xl font-serif gold-gradient"></h1>
            <p id="hero-subtitle" class="text-gray-400 tracking-[0.2em] uppercase text-[9px]"></p>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 mt-6 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
        <button onclick="filterCategory('all')" id="cat-all" class="category-btn active px-5 py-2 rounded-full border border-white/10 whitespace-nowrap text-xs transition-all"></button>
        <button onclick="filterCategory('lunch')" id="cat-lunch" class="category-btn px-5 py-2 rounded-full border border-white/10 whitespace-nowrap text-xs transition-all"></button>
        <button onclick="filterCategory('dinner')" id="cat-dinner" class="category-btn px-5 py-2 rounded-full border border-white/10 whitespace-nowrap text-xs transition-all"></button>
        <button onclick="filterCategory('desserts')" id="cat-desserts" class="category-btn px-5 py-2 rounded-full border border-white/10 whitespace-nowrap text-xs transition-all"></button>
        <button onclick="filterCategory('drinks')" id="cat-drinks" class="category-btn px-5 py-2 rounded-full border border-white/10 whitespace-nowrap text-xs transition-all"></button>
    </div>

    <main class="max-w-6xl mx-auto px-4 py-6">
        <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </main>

    <!-- –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å -->
    <div id="admin-panel" class="fixed top-0 right-0 h-full w-full md:w-[450px] bg-[#0f1115] z-[150] p-6 flex flex-col border-l border-white/10 shadow-2xl overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-serif gold-gradient">–°–∫–ª–∞–¥ –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <button onclick="toggleAdmin()"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div class="bg-white/5 p-4 rounded-2xl mb-6 space-y-3 border border-white/5">
            <h3 class="text-xs font-bold text-yellow-500 uppercase">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –±–ª—é–¥–æ</h3>
            <input type="text" id="new-name-ru" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)" class="w-full bg-black/30 border border-white/10 p-2 rounded-lg text-sm text-white outline-none">
            <div class="grid grid-cols-2 gap-2">
                <input type="number" id="new-price" placeholder="–¶–µ–Ω–∞ ($)" class="w-full bg-black/30 border border-white/10 p-2 rounded-lg text-sm text-white">
                <input type="number" id="new-stock" placeholder="–ö–æ–ª-–≤–æ –ø–æ—Ä—Ü–∏–π" class="w-full bg-black/30 border border-white/10 p-2 rounded-lg text-sm text-white">
            </div>
            <select id="new-cat" class="w-full bg-black/30 border border-white/10 p-2 rounded-lg text-sm text-white">
                <option value="lunch">–û–±–µ–¥</option>
                <option value="dinner">–£–∂–∏–Ω</option>
                <option value="desserts">–î–µ—Å–µ—Ä—Ç—ã</option>
                <option value="drinks">–ù–∞–ø–∏—Ç–∫–∏</option>
            </select>
            <input type="file" id="new-img-file" accept="image/*" class="text-[10px] text-gray-500">
            <div id="img-preview" class="h-32 w-full rounded-lg bg-black/50 hidden bg-center bg-cover border border-white/10"></div>
            <button onclick="saveNewItem()" class="w-full bg-yellow-500 py-3 rounded-xl font-bold text-black text-sm hover:bg-yellow-400 transition">–î–æ–±–∞–≤–∏—Ç—å –≤ –º–µ–Ω—é</button>
        </div>

        <div id="admin-items-list" class="space-y-3 pb-10"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
    <div id="product-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="bg-[#16191e] w-full max-w-md rounded-3xl overflow-hidden border border-white/10 relative text-white">
            <button onclick="closeModal()" class="absolute top-4 right-4 z-10 bg-black/50 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <img id="modal-img" src="" class="w-full h-56 object-cover">
            <div class="p-6">
                <div id="modal-badge-stock" class="hidden text-[10px] font-bold text-red-500 bg-red-500/10 px-2 py-1 rounded-full mb-2 inline-block">–û–°–¢–ê–õ–û–°–¨ –ú–ê–õ–û!</div>
                <h3 id="modal-name" class="text-xl font-serif gold-gradient mb-2"></h3>
                <div class="flex justify-between items-center mb-6">
                    <span id="modal-price" class="text-xl font-bold text-yellow-500"></span>
                    <span id="modal-stock-text" class="text-xs text-gray-500"></span>
                </div>
                
                <div class="flex items-center justify-center gap-4 bg-white/5 p-2 rounded-xl mb-4">
                    <button onclick="updateModalQty(-1)" class="w-10 h-10 rounded-lg bg-white/10 hover:bg-white/20"><i class="fa-solid fa-minus"></i></button>
                    <span id="modal-qty" class="text-xl font-bold w-8 text-center">1</span>
                    <button onclick="updateModalQty(1)" class="w-10 h-10 rounded-lg bg-white/10 hover:bg-white/20"><i class="fa-solid fa-plus"></i></button>
                </div>
                <button onclick="confirmAddToCart()" id="modal-add-btn" class="w-full py-4 rounded-xl font-bold text-black uppercase text-xs transition"></button>
            </div>
        </div>
    </div>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <div id="cart-panel" class="fixed top-0 right-0 h-full w-full md:w-[350px] bg-[#16191e] z-[60] p-6 flex flex-col border-l border-white/5 shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 id="cart-title" class="text-xl font-serif text-white"></h2>
            <button onclick="toggleCart()"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto space-y-2 mb-4"></div>
        <div class="border-t border-white/5 pt-4 space-y-3">
            <div class="flex justify-between font-bold text-white"><span id="total-label"></span><span id="total-price" class="text-yellow-500"></span></div>
            <input type="text" id="order-room" placeholder="–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-sm text-white outline-none focus:border-yellow-500">
            <button onclick="sendOrder()" id="confirm-btn-text" class="w-full bg-yellow-500 py-3 rounded-xl font-bold text-black transition"></button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –õ–æ–≥–∏–Ω–∞ -->
    <div id="login-modal" class="fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="bg-[#16191e] p-8 rounded-3xl border border-white/10 w-full max-w-xs text-center">
            <h2 class="text-xl font-serif gold-gradient mb-6">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl mb-4 outline-none text-center text-white">
            <button onclick="checkAdmin()" class="w-full bg-yellow-500 py-3 rounded-xl font-bold text-black">–í–æ–π—Ç–∏</button>
            <button onclick="closeLogin()" class="mt-4 text-gray-500 text-xs">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="qr-modal" class="fixed inset-0 z-[101] flex items-center justify-center p-4">
        <div class="bg-[#16191e] p-8 rounded-3xl border border-white/10 text-center max-w-sm w-full">
            <div id="qrcode" class="mb-6 flex justify-center bg-white p-4 rounded-xl"></div>
            <button onclick="closeQR()" class="w-full py-3 bg-white/5 rounded-xl text-sm text-white font-bold">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[300] hidden px-6 py-3 rounded-full text-xs font-bold text-white shadow-2xl animate-bounce"></div>

    <script>
        const botToken = "8239778303:AAHAQEcIIP9TM-RrZzr-Le8Vnd5IYGFWuVk"; 
        const MY_USER_ID = "1350897608";
        const ADMIN_PASSWORD = "0711072006122112"; 

        let currentLang = 'ru';
        let cart = [];
        let dynamicMenu = [];
        let isAdmin = false;
        let activeCategory = 'all';

        const uiStrings = {
            ru: {
                heroTitle: "Shoxjahon Restaurant", heroSubtitle: "–í–∞—à –∫–æ–º—Ñ–æ—Ä—Ç ‚Äî –Ω–∞—à–∞ –∑–∞–±–æ—Ç–∞",
                catAll: "–í—Å–µ", catLunch: "–û–±–µ–¥", catDinner: "–£–∂–∏–Ω", catDesserts: "–î–µ—Å–µ—Ä—Ç—ã", catDrinks: "–ù–∞–ø–∏—Ç–∫–∏",
                cartTitle: "–ú–æ–π –∑–∞–∫–∞–∑", total: "–°—É–º–º–∞:",
                confirmBtn: "–ó–∞–∫–∞–∑–∞—Ç—å —Å–µ–π—á–∞—Å", emptyCart: "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞",
                modalAdd: "–í –∫–æ—Ä–∑–∏–Ω—É", toastAdded: "–î–æ–±–∞–≤–ª–µ–Ω–æ!", toastSent: "–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!",
                lowStock: "–û—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ!", noStock: "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏",
                limitError: "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å—Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ü–∏–π –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"
            },
            uz: {
                heroTitle: "Shoxjahon Restaurant", heroSubtitle: "Sizning qulayligingiz ‚Äî bizning maqsadimiz",
                catAll: "Barchasi", catLunch: "Tushlik", catDinner: "Kechki ovqat", catDesserts: "Desertlar", catDrinks: "Ichimliklar",
                cartTitle: "Mening buyurtmam", total: "Jami:",
                confirmBtn: "Buyurtma berish", emptyCart: "Savat bo'sh",
                modalAdd: "Savatga qo'shish", toastAdded: "Qo'shildi!", toastSent: "Yuborildi!",
                lowStock: "Oz qoldi!", noStock: "Tugadi",
                limitError: "Kechirasiz, buncha porsiya mavjud emas"
            }
        };

        async function loadDynamicMenu() {
            const menuRef = window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'menu');
            window.fs.onSnapshot(menuRef, (snapshot) => {
                dynamicMenu = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMenu(activeCategory);
                renderAdminList();
            }, (err) => console.error("Menu fetch error:", err));
        }

        function filterCategory(cat) {
            activeCategory = cat;
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('cat-' + cat).classList.add('active');
            renderMenu(cat);
        }

        function renderMenu(filter = 'all') {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filtered = filter === 'all' ? dynamicMenu : dynamicMenu.filter(i => i.cat === filter);
            
            filtered.forEach(item => {
                const name = item.name[currentLang] || item.name['ru'];
                const isLow = item.stock > 0 && item.stock <= 3;
                const isOut = item.stock <= 0;
                
                grid.innerHTML += `
                    <div class="card-glass p-3 rounded-2xl flex flex-col relative ${isOut ? 'opacity-50 grayscale' : 'cursor-pointer'}" 
                         ${isOut ? '' : `onclick="openProductModal('${item.id}')"`}>
                        
                        ${isLow ? `<div class="absolute top-2 left-2 z-10 bg-red-600 text-white text-[8px] font-bold px-2 py-1 rounded-full uppercase shadow-lg animate-pulse">${uiStrings[currentLang].lowStock}</div>` : ''}
                        ${isOut ? `<div class="absolute inset-0 z-20 flex items-center justify-center bg-black/40 rounded-2xl"><span class="bg-black text-white text-[10px] px-3 py-1 rounded-full font-bold uppercase">${uiStrings[currentLang].noStock}</span></div>` : ''}

                        <div class="relative overflow-hidden rounded-xl h-28 mb-3 border border-white/5">
                            <img src="${item.img}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-white text-[10px] font-bold truncate">${name}</span>
                            <div class="flex justify-between items-center">
                                <span class="text-yellow-500 text-xs font-bold">$${item.price}</span>
                                <span class="text-[9px] text-gray-500">${item.stock} —à—Ç.</span>
                            </div>
                        </div>
                    </div>`;
            });
        }

        let currentProduct = null, modalQty = 1;
        function openProductModal(id) {
            currentProduct = dynamicMenu.find(m => m.id === id);
            if (!currentProduct || currentProduct.stock <= 0) return;
            
            modalQty = 1;
            const isLow = currentProduct.stock <= 3;
            
            document.getElementById('modal-img').src = currentProduct.img;
            document.getElementById('modal-name').innerText = currentProduct.name[currentLang] || currentProduct.name['ru'];
            document.getElementById('modal-price').innerText = '$' + currentProduct.price;
            document.getElementById('modal-qty').innerText = modalQty;
            document.getElementById('modal-stock-text').innerText = `–í –Ω–∞–ª–∏—á–∏–∏: ${currentProduct.stock}`;
            document.getElementById('modal-add-btn').innerText = uiStrings[currentLang].modalAdd;
            document.getElementById('modal-add-btn').className = "w-full py-4 rounded-xl font-bold text-black uppercase text-xs transition bg-yellow-500 hover:bg-yellow-400";
            
            const badge = document.getElementById('modal-badge-stock');
            if(isLow) {
                badge.innerText = uiStrings[currentLang].lowStock;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            document.getElementById('product-modal').style.display = 'flex';
        }

        function updateModalQty(d) {
            const nextQty = modalQty + d;
            if (nextQty >= 1 && nextQty <= currentProduct.stock) {
                modalQty = nextQty;
                document.getElementById('modal-qty').innerText = modalQty;
            } else if (nextQty > currentProduct.stock) {
                showToast(uiStrings[currentLang].limitError, "bg-orange-600");
            }
        }

        function confirmAddToCart() {
            const ex = cart.find(i => i.id === currentProduct.id);
            const currentInCart = ex ? ex.qty : 0;
            
            if (currentInCart + modalQty > currentProduct.stock) {
                showToast(uiStrings[currentLang].limitError, "bg-orange-600");
                return;
            }

            if(ex) ex.qty += modalQty; else cart.push({...currentProduct, qty: modalQty});
            closeModal(); 
            updateCartUI(); 
            showToast(uiStrings[currentLang].toastAdded, "bg-green-600");
        }

        // –ê–¥–º–∏–Ω –õ–æ–≥–∏–∫–∞
        const imgInput = document.getElementById('new-img-file');
        const imgPreview = document.getElementById('img-preview');
        let selectedImgBase64 = null;

        imgInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 500 / img.width;
                    canvas.width = 500; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    selectedImgBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    imgPreview.style.backgroundImage = `url(${selectedImgBase64})`;
                    imgPreview.classList.remove('hidden');
                };
            };
            reader.readAsDataURL(file);
        };

        async function saveNewItem() {
            const name = document.getElementById('new-name-ru').value;
            const price = document.getElementById('new-price').value;
            const stock = document.getElementById('new-stock').value;
            const cat = document.getElementById('new-cat').value;

            if (!name || !price || !stock || !selectedImgBase64) {
                showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "bg-red-500");
                return;
            }

            try {
                await window.fs.addDoc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'menu'), {
                    name: { ru: name, uz: name },
                    price: parseFloat(price),
                    stock: parseInt(stock),
                    cat: cat,
                    img: selectedImgBase64,
                    createdAt: window.fs.serverTimestamp()
                });
                showToast("–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ", "bg-green-600");
                imgPreview.classList.add('hidden');
                document.getElementById('new-name-ru').value = '';
                document.getElementById('new-price').value = '';
                document.getElementById('new-stock').value = '';
                selectedImgBase64 = null;
            } catch (e) { showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "bg-red-500"); }
        }

        function renderAdminList() {
            const list = document.getElementById('admin-items-list');
            list.innerHTML = '<h3 class="text-[10px] text-gray-500 uppercase font-bold mb-2">–¢–µ–∫—É—â–µ–µ –º–µ–Ω—é –∏ —Å–∫–ª–∞–¥</h3>';
            dynamicMenu.forEach(item => {
                list.innerHTML += `
                    <div class="flex items-center justify-between bg-white/5 p-3 rounded-xl border border-white/5">
                        <div class="flex items-center gap-3">
                            <img src="${item.img}" class="w-10 h-10 rounded-lg object-cover">
                            <div class="text-[10px]">
                                <div class="text-white font-bold">${item.name.ru}</div>
                                <div class="text-yellow-500 font-bold">$${item.price}</div>
                                <div class="text-gray-400">–ù–∞ —Å–∫–ª–∞–¥–µ: <span class="${item.stock <= 3 ? 'text-red-500 font-bold' : ''}">${item.stock}</span></div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                             <button onclick="updateStock('${item.id}')" class="bg-blue-500/20 text-blue-500 p-2 rounded-lg text-xs"><i class="fa-solid fa-box"></i></button>
                             <button onclick="deleteItem('${item.id}')" class="bg-red-500/20 text-red-500 p-2 rounded-lg text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        }

        async function updateStock(id) {
            const item = dynamicMenu.find(i => i.id === id);
            const newVal = prompt(`–ò–∑–º–µ–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è "${item.name.ru}"`, item.stock);
            if (newVal !== null && !isNaN(newVal)) {
                await window.fs.updateDoc(window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'menu', id), {
                    stock: parseInt(newVal)
                });
            }
        }

        async function deleteItem(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ?")) {
                await window.fs.deleteDoc(window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'menu', id));
            }
        }

        async function sendOrder() {
            const room = document.getElementById('order-room').value;
            if(!cart.length || !room) { showToast("–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã", "bg-orange-600"); return; }
            
            const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            
            try {
                // –°–ø–∏—Å—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –≤ Firestore
                for (const item of cart) {
                    const menuDoc = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'menu', item.id);
                    const freshData = (await window.fs.getDoc(menuDoc)).data();
                    const newStock = Math.max(0, (freshData.stock || 0) - item.qty);
                    await window.fs.updateDoc(menuDoc, { stock: newStock });
                }

                if (window.user) {
                   await window.fs.addDoc(window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.user.uid, 'orders'), {
                        room, total, items: cart.map(i => ({name: i.name.ru, qty: i.qty})), status: 'new', createdAt: window.fs.serverTimestamp()
                    });
                }

                // Telegram
                let text = `üî• <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó</b>\n<b>–ö–æ–º–Ω–∞—Ç–∞:</b> ${room}\n\n`;
                cart.forEach(i => text += `‚Ä¢ ${i.name.ru} x${i.qty}\n`);
                text += `\n<b>–ò–¢–û–ì–û: $${total}</b>`;

                await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: MY_USER_ID, text, parse_mode: 'HTML' })
                });

                showToast(uiStrings[currentLang].toastSent, "bg-green-600");
                cart = []; updateCartUI(); toggleCart();
            } catch(e) { 
                console.error(e);
                showToast("–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞", "bg-red-600"); 
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function setLang(l) {
            currentLang = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('lang-' + l).classList.add('active');
            const t = uiStrings[l];
            document.getElementById('hero-title').innerText = t.heroTitle;
            document.getElementById('hero-subtitle').innerText = t.heroSubtitle;
            document.getElementById('cat-all').innerText = t.catAll;
            document.getElementById('cat-lunch').innerText = t.catLunch;
            document.getElementById('cat-dinner').innerText = t.catDinner;
            document.getElementById('cat-desserts').innerText = t.catDesserts;
            document.getElementById('cat-drinks').innerText = t.catDrinks;
            document.getElementById('cart-title').innerText = t.cartTitle;
            document.getElementById('total-label').innerText = t.total;
            document.getElementById('confirm-btn-text').innerText = t.confirmBtn;
            renderMenu(activeCategory);
        }

        function updateCartUI() {
            const list = document.getElementById('cart-items');
            list.innerHTML = cart.length ? '' : `<p class="text-center mt-10 text-gray-500 text-[10px] uppercase">${uiStrings[currentLang].emptyCart}</p>`;
            let sum = 0;
            cart.forEach(item => {
                sum += item.price * item.qty;
                list.innerHTML += `<div class="bg-white/5 p-3 rounded-xl flex justify-between items-center text-xs">
                    <div class="flex items-center gap-2">
                        <img src="${item.img}" class="w-8 h-8 rounded-lg object-cover">
                        <div>
                            <div class="text-white font-bold">${item.name[currentLang] || item.name['ru']}</div>
                            <div class="text-gray-500 text-[10px]">x${item.qty}</div>
                        </div>
                    </div>
                    <button onclick="removeFromCart('${item.id}')" class="text-red-500/50 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                </div>`;
            });
            document.getElementById('total-price').innerText = '$' + sum;
            document.getElementById('cart-count').innerText = cart.length;
        }

        function removeFromCart(id) { cart = cart.filter(i => i.id !== id); updateCartUI(); }
        function toggleCart() { document.getElementById('cart-panel').classList.toggle('open'); }
        function toggleAdmin() { document.getElementById('admin-panel').classList.toggle('open'); }
        function openLogin() { document.getElementById('login-modal').style.display = 'flex'; }
        function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
        function closeModal() { document.getElementById('product-modal').style.display = 'none'; }
        
        function checkAdmin() {
            if(document.getElementById('admin-pass').value === ADMIN_PASSWORD) {
                isAdmin = true; document.body.classList.add('is-admin');
                closeLogin(); showToast("–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω", "bg-green-600");
            } else showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥", "bg-red-600");
        }
        function logoutAdmin() {
            isAdmin = false; document.body.classList.remove('is-admin');
            document.getElementById('admin-panel').classList.remove('open');
        }

        function showQRCode() {
            const cont = document.getElementById("qrcode"); cont.innerHTML = "";
            new QRCode(cont, { text: window.location.href, width: 150, height: 150 });
            document.getElementById('qr-modal').style.display = 'flex';
        }
        function closeQR() { document.getElementById('qr-modal').style.display = 'none'; }

        function showToast(m, c) {
            const t = document.getElementById('toast');
            t.innerText = m; t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 z-[300] px-6 py-3 rounded-full text-white font-bold ${c} shadow-xl block animate-bounce`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        window.onload = () => setLang('ru');
    </script>
</body>
</html>