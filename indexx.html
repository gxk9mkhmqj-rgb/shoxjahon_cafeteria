<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoxjahon Restaurant - Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, serverTimestamp, query, orderBy, increment, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // –í–ê–®–ò –ê–ö–¢–£–ê–õ–¨–ù–´–ï –ö–õ–Æ–ß–ò FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDf9HwthRLvTcBVkazMtL3GQF1QnOEiAUc",
            authDomain: "admin-cafe-e8bd1.firebaseapp.com",
            projectId: "admin-cafe-e8bd1",
            storageBucket: "admin-cafe-e8bd1.firebasestorage.app",
            messagingSenderId: "425566150230",
            appId: "1:425566150230:web:eb29d0362709fe8b40a5f7",
            measurementId: "G-J7J8390JX2"
        };
        
        const appId = 'shoxjahon-rest-smart';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.fs = { collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDoc, serverTimestamp, query, orderBy, increment, where };
        
        const initAuth = async () => {
            try {
                // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è GitHub Pages
                await signInAnonymously(auth);
            } catch (error) { 
                console.error("Auth error:", error); 
                showToast("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase.");
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            if (user) {
                loadMenu();
                loadOrders();
                loadUserOrders(); 
            }
        });
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #0b0d11; color: #e5e7eb; -webkit-tap-highlight-color: transparent; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .gold-text { background: linear-gradient(135deg, #d4af37 0%, #f9d976 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .category-btn.active { background: #d4af37; color: #000; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        .lang-btn.active { color: #d4af37 !important; border-bottom: 2px solid #d4af37; }
        #cart-sidebar, #admin-panel, #user-orders-panel { transform: translateX(100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #cart-sidebar.open, #admin-panel.open, #user-orders-panel.open { transform: translateX(0); visibility: visible; }
        #item-modal { opacity: 0; pointer-events: none; transition: 0.3s ease; }
        #item-modal.open { opacity: 1; pointer-events: auto; }
        .hero-bg { background-image: linear-gradient(to bottom, rgba(11, 17, 17, 0.3), #0b0d11), url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pay-method-btn.active { border-color: #d4af37; background: rgba(212, 175, 55, 0.1); color: #d4af37; }
        .loader { border-top-color: #d4af37; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen pb-20">

    <nav class="sticky top-0 z-50 glass py-4 px-4 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-4">
            <div class="text-xl font-serif gold-text font-bold">Shoxjahon</div>
            <button onclick="openPassModal()" class="text-[10px] text-gray-500 hover:text-yellow-500 font-bold uppercase tracking-widest">Admin</button>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleUserOrders()" class="relative p-2 bg-white/5 rounded-full border border-white/10">
                <i class="fa-solid fa-clock-rotate-left text-lg text-white"></i>
                <span id="orders-count" class="hidden absolute -top-1 -right-1 bg-blue-500 text-white text-[8px] font-bold w-4 h-4 rounded-full flex items-center justify-center">0</span>
            </button>
            <button onclick="toggleCart()" class="relative p-2 ml-1 bg-white/5 rounded-full border border-white/10">
                <i class="fa-solid fa-cart-shopping text-lg text-white"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-yellow-500 text-black text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
            </button>
        </div>
    </nav>

    <div class="flex justify-center gap-4 py-2 bg-black/40 text-[10px] border-b border-white/5">
        <button onclick="changeLang('ru')" id="btn-ru" class="lang-btn px-2 py-1 text-gray-400">RU</button>
        <button onclick="changeLang('uz')" id="btn-uz" class="lang-btn px-2 py-1 text-gray-400">UZ</button>
        <button onclick="changeLang('en')" id="btn-en" class="lang-btn px-2 py-1 text-gray-400">EN</button>
        <button onclick="changeLang('cn')" id="btn-cn" class="lang-btn px-2 py-1 text-gray-400">CN</button>
    </div>

    <header class="h-[20vh] relative flex items-center justify-center text-center px-4 hero-bg">
        <div>
            <h1 id="ui-hero-title" class="text-3xl font-serif gold-text mb-1 uppercase tracking-widest font-bold"></h1>
            <p id="ui-hero-sub" class="text-[9px] text-gray-300 uppercase tracking-widest opacity-80"></p>
        </div>
    </header>

    <div class="flex gap-2 overflow-x-auto px-4 py-4 no-scrollbar sticky top-[108px] z-40 bg-[#0b0d11]/90 backdrop-blur-xl">
        <button onclick="filterBy('all')" id="cat-all" class="category-btn active whitespace-nowrap px-5 py-2 rounded-full border border-white/10 text-[10px] font-bold transition-all"></button>
        <button onclick="filterBy('lunch')" id="cat-lunch" class="category-btn whitespace-nowrap px-5 py-2 rounded-full border border-white/10 text-[10px] font-bold transition-all"></button>
        <button onclick="filterBy('dinner')" id="cat-dinner" class="category-btn whitespace-nowrap px-5 py-2 rounded-full border border-white/10 text-[10px] font-bold transition-all"></button>
        <button onclick="filterBy('desserts')" id="cat-desserts" class="category-btn whitespace-nowrap px-5 py-2 rounded-full border border-white/10 text-[10px] font-bold transition-all"></button>
        <button onclick="filterBy('drinks')" id="cat-drinks" class="category-btn whitespace-nowrap px-5 py-2 rounded-full border border-white/10 text-[10px] font-bold transition-all"></button>
    </div>

    <main class="px-4 grid grid-cols-2 md:grid-cols-4 gap-3" id="menu-grid"></main>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
    <div id="item-modal" class="fixed inset-0 z-[150] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm rounded-3xl overflow-hidden flex flex-col">
            <div class="relative h-56">
                <img id="modal-img" src="" class="w-full h-full object-cover">
                <button onclick="closeItemModal()" class="absolute top-4 right-4 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6">
                <h3 id="modal-name" class="text-lg font-serif gold-text font-bold mb-1"></h3>
                <p id="modal-desc" class="text-[10px] text-gray-400 mb-4"></p>
                <div class="flex justify-between items-center mb-6">
                    <span id="modal-price" class="text-xl font-bold text-yellow-500"></span>
                    <div class="flex items-center gap-3 bg-white/5 px-3 py-1.5 rounded-xl border border-white/10">
                        <button onclick="changeModalQty(-1)" class="text-yellow-500"><i class="fa-solid fa-minus"></i></button>
                        <span id="modal-qty" class="text-sm font-bold w-4 text-center">1</span>
                        <button onclick="changeModalQty(1)" class="text-yellow-500"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <button onclick="confirmAddToCart()" id="ui-add-to-cart" class="w-full bg-yellow-500 py-4 rounded-xl text-black font-bold uppercase text-[10px] tracking-widest"></button>
            </div>
        </div>
    </div>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full max-md:max-w-full max-w-md bg-[#0b0d11] z-[100] border-l border-white/10 flex flex-col">
        <div class="p-6 border-b border-white/10 flex justify-between items-center">
            <h2 id="ui-cart-title" class="text-xl font-serif gold-text uppercase font-bold"></h2>
            <button onclick="toggleCart()" class="text-xl text-gray-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-6 bg-black/40 border-t border-white/10 space-y-4">
            <div class="flex justify-between items-center text-sm">
                <span id="ui-total-label" class="text-gray-400"></span>
                <span id="cart-total-price" class="text-xl font-bold text-yellow-500"></span>
            </div>
            <input type="text" id="order-room" class="w-full bg-white/5 border border-white/10 py-3 px-4 rounded-xl text-sm outline-none focus:border-yellow-500" placeholder="">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setPayment('cash')" id="pay-cash" class="pay-method-btn active flex items-center justify-center gap-2 border border-white/10 py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider">
                    <i class="fa-solid fa-money-bill-wave"></i> <span id="ui-pay-cash"></span>
                </button>
                <button onclick="setPayment('card')" id="pay-card" class="pay-method-btn flex items-center justify-center gap-2 border border-white/10 py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider">
                    <i class="fa-solid fa-credit-card"></i> <span id="ui-pay-card"></span>
                </button>
            </div>
            <button onclick="checkout()" id="ui-order-btn" class="w-full bg-yellow-500 py-4 rounded-xl text-black font-bold uppercase text-[10px]"></button>
        </div>
    </div>

    <!-- –ú–æ–∏ –∑–∞–∫–∞–∑—ã -->
    <div id="user-orders-panel" class="fixed top-0 right-0 h-full w-full max-w-md bg-[#0b0d11] z-[120] border-l border-white/10 flex flex-col">
        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
            <h2 id="ui-my-orders" class="text-xl font-serif gold-text uppercase font-bold"></h2>
            <button onclick="toggleUserOrders()" class="text-xl text-gray-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="user-orders-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
    </div>

    <!-- –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å -->
    <div id="admin-panel" class="fixed top-0 left-0 h-full w-full bg-[#0b0d11] z-[200] flex flex-col overflow-hidden">
        <div class="p-4 border-b border-white/10 flex justify-between items-center glass">
            <h2 class="text-lg font-bold gold-text uppercase">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <button onclick="toggleAdmin()" class="text-xl text-gray-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="flex bg-white/5 border-b border-white/10">
            <button onclick="setAdminTab('orders')" id="tab-orders" class="flex-1 py-3 text-[10px] font-bold uppercase text-yellow-500 border-b-2 border-yellow-500">–ó–∞–∫–∞–∑—ã</button>
            <button onclick="setAdminTab('menu')" id="tab-menu" class="flex-1 py-3 text-[10px] font-bold uppercase text-gray-500">–ú–µ–Ω—é</button>
        </div>

        <div id="admin-content" class="flex-1 overflow-y-auto p-4">
            <!-- –°–µ–∫—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ -->
            <div id="admin-sec-orders" class="space-y-4">
                <div id="admin-orders-active" class="grid grid-cols-1 gap-3"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –º–µ–Ω—é -->
            <div id="admin-sec-menu" class="hidden space-y-6">
                <div class="glass p-4 rounded-2xl border border-white/10 space-y-3">
                    <h3 class="text-yellow-500 font-bold uppercase text-[9px]">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</h3>
                    <input type="text" id="adm-name-ru" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (RU)" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-xs">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="adm-price" placeholder="–¶–µ–Ω–∞ ($)" class="bg-white/5 border border-white/10 p-3 rounded-xl text-xs">
                        <input type="number" id="adm-stock" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" class="bg-white/5 border border-white/10 p-3 rounded-xl text-xs">
                    </div>
                    <select id="adm-cat" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-xs text-gray-400">
                        <option value="lunch">–û–±–µ–¥</option><option value="dinner">–£–∂–∏–Ω</option>
                        <option value="desserts">–î–µ—Å–µ—Ä—Ç—ã</option><option value="drinks">–ù–∞–ø–∏—Ç–∫–∏</option>
                    </select>
                    
                    <div class="space-y-2">
                        <p class="text-[8px] text-gray-500 uppercase">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</p>
                        <div class="relative w-full">
                            <input type="file" id="adm-file" accept="image/*" class="hidden">
                            <label for="adm-file" id="file-label" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-white/10 rounded-xl cursor-pointer hover:border-yellow-500 transition-all bg-white/5 overflow-hidden">
                                <div id="preview-container" class="hidden absolute inset-0 w-full h-full bg-black">
                                    <img id="img-preview" class="w-full h-full object-cover opacity-50">
                                </div>
                                <i class="fa-solid fa-camera text-xl text-gray-500 mb-2 z-10"></i>
                                <span class="text-[9px] text-gray-400 uppercase tracking-widest z-10" id="file-name-display">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="addItemToMenu()" id="add-btn" class="w-full bg-yellow-500 text-black font-bold py-4 rounded-xl uppercase text-[10px] flex items-center justify-center gap-2 mt-4">
                        <span>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</span>
                        <div id="btn-loader" class="hidden w-4 h-4 border-2 border-black rounded-full loader"></div>
                    </button>
                </div>

                <div class="space-y-3">
                    <h3 class="text-yellow-500 font-bold uppercase text-[9px]">–°–ø–∏—Å–æ–∫ –±–ª—é–¥</h3>
                    <div id="admin-menu-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è -->
    <div id="password-modal" class="fixed inset-0 z-[300] bg-black/90 backdrop-blur-md flex items-center justify-center hidden">
        <div class="glass p-8 rounded-3xl w-full max-w-xs text-center border border-white/10">
            <h3 class="gold-text font-bold mb-4 uppercase text-sm">–í—Ö–æ–¥ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</h3>
            <input type="password" id="admin-pass-input" placeholder="–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-center outline-none focus:border-yellow-500 mb-4 text-white">
            <button onclick="checkAdminPass()" class="w-full bg-yellow-500 text-black py-3 rounded-xl font-bold text-xs uppercase">–í–æ–π—Ç–∏</button>
            <button onclick="closePassModal()" class="mt-4 text-gray-500 text-[10px] uppercase underline">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[400] px-6 py-3 rounded-xl bg-yellow-500 text-black font-bold text-xs hidden shadow-2xl"></div>

    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
        const TG_TOKEN = "8343721890:AAEEkP2fwhuaqAV12IpbKnWkLcx4LNd3irQ";
        const TG_CHAT_ID = "1350897608";
        const ADMIN_PASSWORD = "07110720";

        let currentLang = localStorage.getItem('shox_lang') || 'ru';
        let cart = JSON.parse(localStorage.getItem('shox_cart')) || []; 
        let menuData = [];
        let activeCat = 'all';
        let selectedItemForModal = null;
        let modalQty = 1;
        let paymentMethod = 'cash';
        let compressedBase64 = null;

        const i18n = {
            ru: { heroTitle: "Shoxjahon", heroSub: "–í–∫—É—Å —Ç—Ä–∞–¥–∏—Ü–∏–π –∏ –∫–æ–º—Ñ–æ—Ä—Ç–∞", all: "–í—Å—ë", lunch: "–û–±–µ–¥", dinner: "–£–∂–∏–Ω", desserts: "–î–µ—Å–µ—Ä—Ç—ã", drinks: "–ù–∞–ø–∏—Ç–∫–∏", cart: "–ö–æ—Ä–∑–∏–Ω–∞", total: "–ò—Ç–æ–≥–æ:", order: "–ó–∞–∫–∞–∑–∞—Ç—å", room: "–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã / —Å—Ç–æ–ª–∞", added: "–î–æ–±–∞–≤–ª–µ–Ω–æ!", sent: "–ü—Ä–∏–Ω—è—Ç–æ!", myOrders: "–ú–æ–∏ –∑–∞–∫–∞–∑—ã", statusNew: "–ù–æ–≤—ã–π", statusPrep: "–ì–æ—Ç–æ–≤–∏—Ç—Å—è (1)", statusReady: "–ì–æ—Ç–æ–≤ (2)", statusDone: "–í –ø—É—Ç–∏ (3)", addToCart: "–í –∫–æ—Ä–∑–∏–Ω—É", payCash: "–ù–∞–ª–∏—á–Ω—ã–µ", payCard: "–ö–∞—Ä—Ç–∞" },
            uz: { heroTitle: "Shoxjahon", heroSub: "An'analar va qulaylik", all: "Hammasi", lunch: "Tushlik", dinner: "Kechki ovqat", desserts: "Desertlar", drinks: "Ichimliklar", cart: "Savat", total: "Jami:", order: "Buyurtma", room: "Xona / Stol raqami", added: "Qo'shildi!", sent: "Qabul qilindi!", myOrders: "Buyurtmalar", statusNew: "Yangi", statusPrep: "Tayyorlanmoqda (1)", statusReady: "Tayyor (2)", statusDone: "Yetkazilmoqda (3)", addToCart: "Savat–≥–∞", payCash: "Naqd", payCard: "Karta" },
            en: { heroTitle: "Shoxjahon", heroSub: "Taste of tradition", all: "All", lunch: "Lunch", dinner: "Dinner", desserts: "Desserts", drinks: "Drinks", cart: "Cart", total: "Total:", order: "Order", room: "Room / Table", added: "Added!", sent: "Success!", myOrders: "My Orders", statusNew: "New", statusPrep: "Preparing (1)", statusReady: "Ready (2)", statusDone: "On Way (3)", addToCart: "Add to Cart", payCash: "Cash", payCard: "Card" },
            cn: { heroTitle: "Shoxjahon", heroSub: "‰º†ÁªüÁöÑÂë≥ÈÅì‰∏éËàíÈÄÇ", all: "ÂÖ®ÈÉ®", lunch: "ÂçàÈ§ê", dinner: "ÊôöÈ§ê", desserts: "ÁîúÁÇπ", drinks: "È•ÆÊñô", cart: "Ë¥≠Áâ©ËΩ¶", total: "ÊÄªÈ¢ù:", order: "‰∏ãËÆ¢Âçï", room: "ÊàøÂè∑ / Ê°åÂè∑", added: "Â∑≤Ê∑ªÂä†!", sent: "ÊàêÂäü!", myOrders: "ÊàëÁöÑËÆ¢Âçï", statusNew: "Êñ∞ËÆ¢Âçï", statusPrep: "ÂáÜÂ§á‰∏≠ (1)", statusReady: "Â∑≤Â∞±Áª™ (2)", statusDone: "Ê¥æÈÄÅ‰∏≠ (3)", addToCart: "Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶", payCash: "Áé∞Èáë", payCard: "Èì∂Ë°åÂç°" }
        };

        // –°–∂–∞—Ç–∏–µ —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Firestore
        document.getElementById('adm-file')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const max_size = 500; // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è Firestore

                    if (width > height) {
                        if (width > max_size) { height *= max_size / width; width = max_size; }
                    } else {
                        if (height > max_size) { width *= max_size / height; height = max_size; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    compressedBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    
                    document.getElementById('img-preview').src = compressedBase64;
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('file-name-display').innerText = "–ì–æ—Ç–æ–≤–æ ‚úÖ";
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        async function autoTranslate(text, targetLang) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ru|${targetLang}`);
                const data = await res.json();
                return data.responseData.translatedText;
            } catch (e) { return text; }
        }

        async function addItemToMenu() {
            const n_ru = document.getElementById('adm-name-ru').value;
            const price = parseFloat(document.getElementById('adm-price').value);
            const stock = parseInt(document.getElementById('adm-stock').value);
            const cat = document.getElementById('adm-cat').value;
            const btn = document.getElementById('add-btn');
            const loader = document.getElementById('btn-loader');
            
            if(!n_ru || isNaN(price) || !compressedBase64) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ!");
            
            btn.disabled = true; loader.classList.remove('hidden');

            try {
                const [n_uz, n_en, n_cn] = await Promise.all([
                    autoTranslate(n_ru, 'uz'), autoTranslate(n_ru, 'en'), autoTranslate(n_ru, 'zh')
                ]);

                await window.fs.addDoc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'menu'), {
                    name: { ru: n_ru, uz: n_uz, en: n_en, cn: n_cn }, 
                    price, stock, cat, img: compressedBase64, 
                    createdAt: window.fs.serverTimestamp()
                });

                showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ!");
                document.getElementById('adm-name-ru').value = ''; 
                document.getElementById('adm-price').value = ''; 
                document.getElementById('adm-stock').value = '';
                document.getElementById('preview-container').classList.add('hidden');
                compressedBase64 = null;
            } catch (err) { showToast("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"); } finally { btn.disabled = false; loader.classList.add('hidden'); }
        }

        async function updateStatus(id, newStatus, stepLabel) {
            const orderRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'orders', id);
            await window.fs.updateDoc(orderRef, { status: newStatus });
            
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: TG_CHAT_ID, text: `üîÑ *–ó–∞–∫–∞–∑ #${id.slice(-4)}*\n–°—Ç–∞—Ç—É—Å: *${stepLabel}*`, parse_mode: 'Markdown' })
            });
            showToast("–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω");
        }

        function updateUI() {
            const t = i18n[currentLang];
            document.getElementById('ui-hero-title').innerText = t.heroTitle;
            document.getElementById('ui-hero-sub').innerText = t.heroSub;
            document.getElementById('cat-all').innerText = t.all;
            document.getElementById('cat-lunch').innerText = t.lunch;
            document.getElementById('cat-dinner').innerText = t.dinner;
            document.getElementById('cat-desserts').innerText = t.desserts;
            document.getElementById('cat-drinks').innerText = t.drinks;
            document.getElementById('ui-cart-title').innerText = t.cart;
            document.getElementById('ui-total-label').innerText = t.total;
            document.getElementById('ui-order-btn').innerText = t.order;
            document.getElementById('order-room').placeholder = t.room;
            document.getElementById('ui-my-orders').innerText = t.myOrders;
            document.getElementById('ui-add-to-cart').innerText = t.addToCart;
            document.getElementById('ui-pay-cash').innerText = t.payCash;
            document.getElementById('ui-pay-card').innerText = t.payCard;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${currentLang}`)?.classList.add('active');
            renderMenu(); renderCart();
        }

        function setPayment(m) {
            paymentMethod = m;
            document.getElementById('pay-cash').classList.toggle('active', m === 'cash');
            document.getElementById('pay-card').classList.toggle('active', m === 'card');
        }

        async function deleteMenuItem(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å?")) await window.fs.deleteDoc(window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'menu', id));
        }

        function renderAdminMenuList() {
            const list = document.getElementById('admin-menu-list');
            list.innerHTML = menuData.map(item => `
                <div class="glass p-3 rounded-xl flex items-center gap-3">
                    <img src="${item.img}" class="w-10 h-10 rounded-lg object-cover">
                    <div class="flex-1 text-[10px] font-bold">${item.name.ru}</div>
                    <button onclick="deleteMenuItem('${item.id}')" class="text-red-500/70 p-2"><i class="fa-solid fa-trash-can text-xs"></i></button>
                </div>`).join('');
        }

        function renderAdminOrders(orders) {
            const container = document.getElementById('admin-orders-active');
            const active = orders.filter(o => o.status !== 'delivered');
            if(active.length === 0) { container.innerHTML = `<div class="text-center py-10 opacity-30 text-xs uppercase">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>`; return; }
            container.innerHTML = active.map(o => `
                <div class="glass p-4 rounded-xl border-l-4 ${o.status === 'new' ? 'border-blue-500' : (o.status === 'preparing' ? 'border-yellow-500' : 'border-green-500')}">
                    <div class="flex justify-between mb-2">
                        <span class="text-[10px] font-bold uppercase">${o.room} | ${o.payment === 'cash' ? 'üíµ –ù–∞–ª' : 'üí≥ –ö–∞—Ä—Ç–∞'}</span>
                        <span class="text-[9px] opacity-40">#${o.id.slice(-4)}</span>
                    </div>
                    <div class="text-[10px] mb-3">
                        ${o.items.map(i => `<div class="flex justify-between"><span>${i.name.ru}</span> <span>x${i.qty}</span></div>`).join('')}
                    </div>
                    <div class="flex justify-between items-center border-t border-white/5 pt-3">
                        <div class="text-sm font-bold text-yellow-500">$${o.total}</div>
                        <div class="flex gap-2">
                            ${o.status === 'new' ? `<button onclick="updateStatus('${o.id}', 'preparing', '–ì–æ—Ç–æ–≤–∏—Ç—Å—è')" class="bg-blue-600 px-3 py-2 rounded-lg text-[8px] uppercase font-bold">–í —Ä–∞–±–æ—Ç—É</button>` : ''}
                            ${o.status === 'preparing' ? `<button onclick="updateStatus('${o.id}', 'ready', '–ì–æ—Ç–æ–≤')" class="bg-yellow-500 text-black px-3 py-2 rounded-lg text-[8px] uppercase font-bold">–ì–æ—Ç–æ–≤</button>` : ''}
                            ${o.status === 'ready' ? `<button onclick="updateStatus('${o.id}', 'delivered', '–í—ã–¥–∞–Ω')" class="bg-green-600 px-3 py-2 rounded-lg text-[8px] uppercase font-bold">–í—ã–¥–∞–Ω</button>` : ''}
                        </div>
                    </div>
                </div>`).join('');
        }

        function loadMenu() {
            const q = window.fs.query(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'menu'), window.fs.orderBy('createdAt', 'desc'));
            window.fs.onSnapshot(q, (snap) => {
                menuData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMenu();
                if(!document.getElementById('admin-sec-menu').classList.contains('hidden')) renderAdminMenuList();
            });
        }

        function loadOrders() {
            const q = window.fs.query(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'orders'), window.fs.orderBy('createdAt', 'desc'));
            window.fs.onSnapshot(q, (snap) => {
                renderAdminOrders(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
        }

        function loadUserOrders() {
            const uid = window.auth.currentUser?.uid; if(!uid) return;
            const q = window.fs.query(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'orders'), window.fs.where('userId', '==', uid));
            window.fs.onSnapshot(q, (snap) => {
                const orders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                orders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                const activeCount = orders.filter(o => o.status !== 'delivered').length;
                document.getElementById('orders-count').innerText = activeCount;
                document.getElementById('orders-count').classList.toggle('hidden', activeCount === 0);
                renderUserOrdersList(orders);
            });
        }

        function renderMenu() {
            const grid = document.getElementById('menu-grid'); grid.innerHTML = '';
            const filtered = activeCat === 'all' ? menuData : menuData.filter(i => i.cat === activeCat);
            if(filtered.length === 0) { grid.innerHTML = `<div class="col-span-full py-20 text-center opacity-20 text-[10px] uppercase">–ù–µ—Ç –±–ª—é–¥</div>`; return; }
            filtered.forEach(item => {
                const isOut = item.stock <= 0;
                grid.innerHTML += `
                    <div onclick="openItemModal('${item.id}')" class="glass p-2 rounded-2xl flex flex-col ${isOut ? 'opacity-40 grayscale' : ''}">
                        <img src="${item.img}" class="w-full aspect-square rounded-xl object-cover mb-2">
                        <h3 class="text-[10px] font-bold text-white uppercase truncate">${item.name[currentLang] || item.name.ru}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-yellow-500 font-bold text-xs">$${item.price}</span>
                            <span class="w-6 h-6 bg-white/5 rounded-full flex items-center justify-center border border-white/10"><i class="fa-solid fa-plus text-[8px]"></i></span>
                        </div>
                    </div>`;
            });
        }

        function openItemModal(id) {
            const item = menuData.find(m => m.id === id); if (!item || item.stock <= 0) return;
            selectedItemForModal = item; modalQty = 1;
            document.getElementById('modal-img').src = item.img;
            document.getElementById('modal-name').innerText = item.name[currentLang] || item.name.ru;
            document.getElementById('modal-price').innerText = `$${item.price}`;
            document.getElementById('modal-qty').innerText = modalQty;
            document.getElementById('item-modal').classList.add('open');
        }

        function closeItemModal() { document.getElementById('item-modal').classList.remove('open'); }
        function changeModalQty(d) { if(selectedItemForModal && modalQty+d >= 1 && modalQty+d <= selectedItemForModal.stock) { modalQty+=d; document.getElementById('modal-qty').innerText = modalQty; } }

        function confirmAddToCart() {
            const inCart = cart.find(c => c.id === selectedItemForModal.id);
            if(inCart) inCart.qty = Math.min(inCart.qty + modalQty, selectedItemForModal.stock);
            else cart.push({ id: selectedItemForModal.id, name: selectedItemForModal.name, price: selectedItemForModal.price, img: selectedItemForModal.img, qty: modalQty });
            localStorage.setItem('shox_cart', JSON.stringify(cart)); renderCart(); closeItemModal(); showToast(i18n[currentLang].added);
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            document.getElementById('cart-count').innerText = cart.reduce((a, b) => a + b.qty, 0);
            if(cart.length === 0) { container.innerHTML = `<div class="text-center py-20 opacity-40 text-xs">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>`; document.getElementById('cart-total-price').innerText = "$0"; return; }
            container.innerHTML = cart.map(item => `
                <div class="flex items-center gap-3 bg-white/5 p-2 rounded-xl">
                    <img src="${item.img}" class="w-10 h-10 rounded-lg object-cover">
                    <div class="flex-1 text-[10px]">
                        <div class="font-bold uppercase">${item.name[currentLang] || item.name.ru}</div>
                        <div class="text-yellow-500 font-bold">$${item.price}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQty('${item.id}', -1)" class="w-5 h-5 text-[10px]">-</button>
                        <span class="text-[10px] font-bold">${item.qty}</span>
                        <button onclick="updateQty('${item.id}', 1)" class="w-5 h-5 text-[10px]">+</button>
                    </div>
                </div>`).join('');
            document.getElementById('cart-total-price').innerText = `$${cart.reduce((a, b) => a + (b.price * b.qty), 0)}`;
        }

        function updateQty(id, d) {
            const i = cart.find(c => c.id === id); if(i) { i.qty += d; if(i.qty <= 0) cart = cart.filter(c => c.id !== id); localStorage.setItem('shox_cart', JSON.stringify(cart)); renderCart(); }
        }

        async function checkout() {
            const room = document.getElementById('order-room').value.trim();
            if(!room || cart.length === 0) return showToast("–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ!");
            const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            const orderData = { room, payment: paymentMethod, userId: window.auth.currentUser.uid, items: cart.map(i => ({ name: i.name, qty: i.qty, price: i.price, id: i.id })), total, status: 'new', createdAt: window.fs.serverTimestamp() };
            try {
                const docRef = await window.fs.addDoc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'orders'), orderData);
                fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: TG_CHAT_ID, text: `üì• *–ù–û–í–´–ô –ó–ê–ö–ê–ó #${docRef.id.slice(-4)}*\nüìç –°—Ç–æ–ª: ${room}\nüí∞ –°—É–º–º–∞: $${total}\nüí≥ –û–ø–ª–∞—Ç–∞: ${paymentMethod}`, parse_mode: 'Markdown' }) });
                cart = []; localStorage.setItem('shox_cart', "[]"); renderCart(); toggleCart(); showToast(i18n[currentLang].sent);
            } catch (e) { showToast("–û—à–∏–±–∫–∞!"); }
        }

        function renderUserOrdersList(orders) {
            const list = document.getElementById('user-orders-list');
            const t = i18n[currentLang];
            if(!orders || orders.length === 0) { list.innerHTML = `<div class="text-center py-10 opacity-20 text-xs">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏</div>`; return; }
            list.innerHTML = orders.map(o => {
                const statusLbl = { 'new': t.statusNew, 'preparing': t.statusPrep, 'ready': t.statusReady, 'delivered': t.statusDone }[o.status];
                return `<div class="glass p-4 rounded-xl mb-2">
                    <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                        <span class="opacity-40">#${o.id.slice(-4)}</span>
                        <span class="text-yellow-500">${statusLbl}</span>
                    </div>
                    <div class="text-[9px] opacity-70">${o.items.map(i => i.name[currentLang] || i.name.ru).join(', ')}</div>
                </div>`;
            }).join('');
        }

        function changeLang(l) { currentLang = l; localStorage.setItem('shox_lang', l); updateUI(); }
        function toggleCart() { document.getElementById('cart-sidebar').classList.toggle('open'); }
        function toggleAdmin() { document.getElementById('admin-panel').classList.toggle('open'); }
        function toggleUserOrders() { document.getElementById('user-orders-panel').classList.toggle('open'); }
        function openPassModal() { document.getElementById('password-modal').classList.remove('hidden'); }
        function closePassModal() { document.getElementById('password-modal').classList.add('hidden'); }
        function checkAdminPass() { if(document.getElementById('admin-pass-input').value === ADMIN_PASSWORD) { closePassModal(); toggleAdmin(); } else showToast("‚ùå –û—à–∏–±–∫–∞"); }
        function setAdminTab(tab) {
            document.getElementById('admin-sec-orders').classList.toggle('hidden', tab !== 'orders');
            document.getElementById('admin-sec-menu').classList.toggle('hidden', tab !== 'menu');
            document.getElementById('tab-orders').className = `flex-1 py-3 text-[10px] font-bold uppercase ${tab === 'orders' ? 'text-yellow-500 border-b-2 border-yellow-500' : 'text-gray-500'}`;
            document.getElementById('tab-menu').className = `flex-1 py-3 text-[10px] font-bold uppercase ${tab === 'menu' ? 'text-yellow-500 border-b-2 border-yellow-500' : 'text-gray-500'}`;
            if(tab === 'menu') renderAdminMenuList();
        }
        function filterBy(c) { activeCat = c; document.querySelectorAll('.category-btn').forEach(b => b.classList.toggle('active', b.id === `cat-${c}`)); renderMenu(); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
        window.addEventListener('load', updateUI);
    </script>
</body>
</html>